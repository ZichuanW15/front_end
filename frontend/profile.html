<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Profile Settings - Asset Trading Platform</title>
  <link rel="icon" type="image/png" href="/frontend/Icons/pvit90.png">
  <link rel="stylesheet" href="common.css">
</head>
<body>
  <nav class="nav">
    <div class="container">
      <div class="nav-content">
        <h1>Profile Settings</h1>
        <div class="nav-links">
          <a href="browsing.html">Browse Assets</a>
          <a href="trading.html">Trading</a>
          <a href="portfolio.html">My Assets</a>
          <a href="valuehistory.html">Value History</a>
          <a href="profile.html" class="active">Profile</a>
          <a href="admin.html" id="adminLink" style="display:none;">Admin</a>
          <button onclick="logout()" class="small">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div>
        <h2>Profile Settings</h2>
        <p class="text-muted">Manage your account information and preferences</p>
      </div>
    </div>

    <!-- Profile Information -->
    <div class="grid">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Account Information</h3>
        <button onclick="toggleEditMode()" class="small" id="editToggleBtn">Edit Profile</button>
      </div>
      
      <form id="profileForm" style="display: none;">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" required>
          <small class="text-muted">Username can be changed</small>
        </div>
        
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" required>
        </div>
        
        <div class="form-group">
          <label for="currentPassword">Current Password</label>
          <input type="password" id="currentPassword" placeholder="Enter current password to verify changes" required>
          <small class="text-muted">Required to verify your identity</small>
        </div>
        
        <div class="form-group">
          <label for="newPassword">New Password</label>
          <input type="password" id="newPassword" placeholder="Leave blank to keep current password">
          <small class="text-muted">Password can be any length</small>
        </div>
        
        <div class="form-group">
          <label for="confirmPassword">Confirm New Password</label>
          <input type="password" id="confirmPassword" placeholder="Confirm new password">
        </div>
        
        <div class="row">
          <button type="submit" class="primary">Update Profile</button>
          <button type="button" onclick="cancelEdit()" class="secondary">Cancel</button>
        </div>
      </form>
      
      <div id="profileDisplay">
        <div class="info-item">
          <label>Username:</label>
          <span id="displayUsername">-</span>
        </div>
        <div class="info-item">
          <label>Email:</label>
          <span id="displayEmail">-</span>
        </div>
      </div>
    </div>
      
      <div class="card">
        <h3>Account Status</h3>
        <div class="info-item">
          <label>Account Type:</label>
          <span id="accountType">Regular User</span>
        </div>
        <div class="info-item">
          <label>Member Since:</label>
          <span id="memberSince">-</span>
        </div>
        <div class="info-item">
          <label>User ID:</label>
          <span id="userId">-</span>
        </div>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="card" style="border-left: 4px solid #dc3545; margin-top: 20px;">
      <h3 style="color: #dc3545;">Danger Zone</h3>
      <p class="text-muted">These actions are irreversible. Please proceed with caution.</p>
      
      <div class="row" style="align-items: center; gap: 20px;">
        <div>
          <h4>Delete Account</h4>
          <p class="text-muted">Permanently delete your account and all associated data. This action cannot be undone.</p>
        </div>
        <button onclick="showDeleteConfirmation()" class="danger">Delete Account</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; max-width: 400px; width: 90%;">
      <h3 style="color: #dc3545; margin-bottom: 20px;">Delete Account</h3>
      <p style="margin-bottom: 20px;">Are you sure you want to delete your account? This action cannot be undone and will permanently remove:</p>
      <ul style="margin-bottom: 20px; padding-left: 20px;">
        <li>Your profile and account information</li>
        <li>All your asset holdings</li>
        <li>Your transaction history</li>
        <li>All associated data</li>
      </ul>
      <p style="margin-bottom: 10px; font-weight: bold;">Type "DELETE" to confirm:</p>
      <input type="text" id="deleteConfirmation" placeholder="Type DELETE to confirm" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
      
      <p style="margin-bottom: 10px; font-weight: bold;">Enter your current password:</p>
      <input type="password" id="deletePassword" placeholder="Enter your current password" style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px;">
      <div class="row">
        <button onclick="hideDeleteConfirmation()" class="secondary col">Cancel</button>
        <button onclick="confirmDeleteAccount()" class="danger col" id="confirmDeleteBtn" disabled>Delete Account</button>
      </div>
    </div>
  </div>

  <div id="msg" class="msg muted" style="display: none;"></div>

<script>
  const API = 'http://localhost:5001'; // Backend API server
  const el = id => document.getElementById(id);
  const setMsg = (txt, ok=null) => {
    const m = el('msg'); 
    m.textContent = txt; 
    m.className = 'msg ' + (ok===null?'muted': ok?'ok':'err');
    m.style.display = 'block';
    setTimeout(() => m.style.display = 'none', 5000);
  };

  // Load user profile data
  async function loadProfile() {
    try {
      console.log('Loading profile data...');
      
      // First, try to get user data from sessionStorage (stored during login)
      const sessionUser = sessionStorage.getItem('user');
      if (sessionUser) {
        console.log('Using sessionStorage user data');
        const user = JSON.parse(sessionUser);
        
        // Populate form fields
        el('username').value = user.user_name || '';
        el('email').value = user.email || '';
        
        // Populate display fields
        el('displayUsername').textContent = user.user_name || '-';
        el('displayEmail').textContent = user.email || '-';
        el('accountType').textContent = user.is_manager ? 'Manager' : 'Regular User';
        el('memberSince').textContent = user.created_at ? new Date(user.created_at).toLocaleDateString() : '-';
        el('userId').textContent = user.user_id || '-';
        
        // Store original values for comparison
        el('username').setAttribute('data-original', user.user_name || '');
        el('email').setAttribute('data-original', user.email || '');
        
        console.log('Profile loaded from sessionStorage');
        // Show admin link if the user is a manager (handle booleans, numbers, and strings)
        try {
          const adminLink = document.getElementById('adminLink');
          const isManager = user.is_manager === true || user.is_manager === 1 || user.is_manager === '1' || user.is_manager === 'true';
          if (adminLink) adminLink.style.display = isManager ? 'inline-block' : 'none';
        } catch (e) {
          console.warn('Could not toggle admin link:', e);
        }
        return; // Success, exit early
      }
      
      // If no sessionStorage data, try API call
      console.log('No sessionStorage data, trying API call...');
      const response = await fetch(`${API}/auth/me`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include' // Include cookies for session-based auth
      });
      
      console.log('Profile response status:', response.status);
      
      if (response.ok) {
        const data = await response.json();
        if (data.status === 'success' && data.user) {
          const user = data.user;
          
          // Populate form fields
          el('username').value = user.user_name || '';
          el('email').value = user.email || '';
          
          // Populate display fields
          el('displayUsername').textContent = user.user_name || '-';
          el('displayEmail').textContent = user.email || '-';
          el('accountType').textContent = user.is_manager ? 'Manager' : 'Regular User';
          el('memberSince').textContent = user.created_at ? new Date(user.created_at).toLocaleDateString() : '-';
          el('userId').textContent = user.user_id || '-';
          
          // Store original values for comparison
          el('username').setAttribute('data-original', user.user_name || '');
          el('email').setAttribute('data-original', user.email || '');
          
          // Store in sessionStorage for future use
          sessionStorage.setItem('user', JSON.stringify(user));
          console.log('Profile loaded from API and stored in sessionStorage');
          // Show admin link if the user is a manager
          try {
            const adminLink = document.getElementById('adminLink');
            const isManager = user.is_manager === true || user.is_manager === 1 || user.is_manager === '1' || user.is_manager === 'true';
            if (adminLink) adminLink.style.display = isManager ? 'inline-block' : 'none';
          } catch (e) {
            console.warn('Could not toggle admin link:', e);
          }
        }
      } else {
        console.log('Profile request failed with status:', response.status);
        const errorData = await response.json().catch(() => ({}));
        console.log('Profile error data:', errorData);
        
        // If API fails and no sessionStorage, show error
        setMsg('Failed to load profile data: ' + (errorData.message || 'Unknown error'), false);
      }
    } catch (error) {
      console.error('Profile load error:', error);
      
      // Check if we have sessionStorage data as fallback
      const sessionUser = sessionStorage.getItem('user');
      if (sessionUser) {
        console.log('API failed, using sessionStorage fallback');
        const user = JSON.parse(sessionUser);
        
        // Populate form fields
        el('username').value = user.user_name || '';
        el('email').value = user.email || '';
        
        // Populate display fields
        el('displayUsername').textContent = user.user_name || '-';
        el('displayEmail').textContent = user.email || '-';
        el('accountType').textContent = user.is_manager ? 'Manager' : 'Regular User';
        el('memberSince').textContent = user.created_at ? new Date(user.created_at).toLocaleDateString() : '-';
        el('userId').textContent = user.user_id || '-';
        
        // Store original values for comparison
        el('username').setAttribute('data-original', user.user_name || '');
        el('email').setAttribute('data-original', user.email || '');
        
        setMsg('Profile loaded (offline mode)', true);
        // Show admin link if the user is a manager in offline/session fallback
        try {
          const adminLink = document.getElementById('adminLink');
          const isManager = user.is_manager === true || user.is_manager === 1 || user.is_manager === '1' || user.is_manager === 'true';
          if (adminLink) adminLink.style.display = isManager ? 'inline-block' : 'none';
        } catch (e) {
          console.warn('Could not toggle admin link in fallback:', e);
        }
      } else {
        setMsg('Error loading profile: ' + error.message, false);
      }
    }
  }
  // Update profile
  async function updateProfile(event) {
    event.preventDefault();
    
    const username = el('username').value.trim();
    const email = el('email').value.trim();
    const currentPassword = el('currentPassword').value;
    const newPassword = el('newPassword').value;
    const confirmPassword = el('confirmPassword').value;
    
    // Validate required fields
    if (!username) {
      setMsg('Username is required', false);
      return;
    }
    
    if (!email) {
      setMsg('Email is required', false);
      return;
    }
    
    if (!currentPassword) {
      setMsg('Current password is required', false);
      return;
    }
    
    // Validate password if changing
    if (newPassword) {
      if (newPassword !== confirmPassword) {
        setMsg('New passwords do not match', false);
        return;
      }
      // No password length restrictions
    }
    
    setMsg('Updating profile...', null);
    
    try {
      const updateData = { 
        user_name: username,
        email: email,
        current_password: currentPassword
      };
      if (newPassword) {
        updateData.password = newPassword;
      }
      
      console.log('Attempting API update...');
      
      const response = await fetch(`${API}/users/${getCurrentUserId()}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include', // Include cookies for session-based auth
        body: JSON.stringify(updateData)
      });
      
      console.log('Update response status:', response.status);
      const data = await response.json();
      
      if (response.ok && data.status === 'success') {
        // Update sessionStorage with new data
        const sessionUser = sessionStorage.getItem('user');
        if (sessionUser) {
          const user = JSON.parse(sessionUser);
          user.user_name = username;
          user.email = email;
          sessionStorage.setItem('user', JSON.stringify(user));
        }
        
        setMsg('Profile updated successfully in database', true);
        el('currentPassword').value = '';
        el('newPassword').value = '';
        el('confirmPassword').value = '';
        loadProfile(); // Reload profile data
        cancelEdit(); // Exit edit mode
      } else {
        console.log('Update failed:', data);
        setMsg(data.message || data.error || 'Failed to update profile', false);
      }
    } catch (error) {
      console.error('Profile update error:', error);
      setMsg('Error updating profile: ' + error.message, false);
    }
  }

  // Delete account
  async function deleteAccount(password) {
    try {
      console.log('Attempting to delete account...');
      setMsg('Deleting account...', null);
      
      const response = await fetch(`${API}/users/${getCurrentUserId()}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          current_password: password
        })
      });
      
      const data = await response.json();
      
      if (response.ok && data.status === 'success') {
        // Clear all session data
        sessionStorage.clear();
        
        setMsg('Account deleted successfully from database', true);
        
        // Redirect to login after a short delay
        setTimeout(() => {
          location.href = 'login.html';
        }, 2000);
        
        console.log('Account deleted successfully from database');
      } else {
        console.error('Delete account failed:', data);
        setMsg(data.message || data.error || 'Failed to delete account', false);
      }
      
    } catch (error) {
      console.error('Delete account error:', error);
      setMsg('Error deleting account: ' + error.message, false);
    }
  }

  // Toggle edit mode
  function toggleEditMode() {
    const form = el('profileForm');
    const display = el('profileDisplay');
    const btn = el('editToggleBtn');
    
    if (form.style.display === 'none') {
      form.style.display = 'block';
      display.style.display = 'none';
      btn.textContent = 'Cancel Edit';
    } else {
      cancelEdit();
    }
  }

  // Cancel edit mode
  function cancelEdit() {
    const form = el('profileForm');
    const display = el('profileDisplay');
    const btn = el('editToggleBtn');
    
    form.style.display = 'none';
    display.style.display = 'block';
    btn.textContent = 'Edit Profile';
    
    // Reset form to original values
    el('username').value = el('username').getAttribute('data-original') || '';
    el('email').value = el('email').getAttribute('data-original') || '';
    el('newPassword').value = '';
    el('confirmPassword').value = '';
  }

  // Utility functions
  function getCurrentUserId() {
    const user = JSON.parse(sessionStorage.getItem('user') || '{}');
    return user.user_id;
  }

  // Removed resetForm function - now using cancelEdit()

  function showDeleteConfirmation() {
    el('deleteModal').style.display = 'block';
    el('deleteConfirmation').value = '';
    el('confirmDeleteBtn').disabled = true;
  }

  function hideDeleteConfirmation() {
    el('deleteModal').style.display = 'none';
  }

  function confirmDeleteAccount() {
    const confirmation = el('deleteConfirmation').value;
    const password = el('deletePassword').value;
    
    if (confirmation !== 'DELETE') {
      setMsg('Please type "DELETE" to confirm', false);
      return;
    }
    
    if (!password) {
      setMsg('Please enter your current password', false);
      return;
    }
    
    deleteAccount(password);
    hideDeleteConfirmation();
  }



  // Event listeners
  el('profileForm').addEventListener('submit', updateProfile);
  el('deleteConfirmation').addEventListener('input', function() {
    updateDeleteButtonState();
  });

  el('deletePassword').addEventListener('input', function() {
    updateDeleteButtonState();
  });

  function updateDeleteButtonState() {
    const confirmation = el('deleteConfirmation').value;
    const password = el('deletePassword').value;
    el('confirmDeleteBtn').disabled = confirmation !== 'DELETE' || !password;
  }

  // Check authentication and load profile
  document.addEventListener('DOMContentLoaded', function() {
    // Check if user is logged in by trying to load profile
    loadProfile().catch(() => {
      // If profile loading fails, redirect to login
      location.href = 'login.html';
    });
  });


  async function logout() {
    try {
      await fetch(`${API_BASE}/auth/logout`, { method: 'POST', credentials: 'include' });
    } catch (e) {
      // swallow network errors; proceed to clear session
    } finally {
      try { sessionStorage.clear(); } catch (_) {}
      location.href = 'login.html';
    }
  }
</script>
</body>
</html>