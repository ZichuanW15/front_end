<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Asset Value History - Asset Trading Platform</title>
  <link rel="stylesheet" href="common.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav class="nav">
    <div class="container">
      <div class="nav-content">
        <h1>Asset Value History</h1>
        <div class="nav-links">
          <a href="browsing.html">Browse Assets</a>
          <a href="trading.html">Trading</a>
          <a href="portfolio.html">My Assets</a>
          <a href="valuehistory.html" class="active">Value History</a>
          <a href="profile.html">Profile</a>
          <a href="admin.html" id="adminLink" style="display:none;">Admin</a>
          <button onclick="logout()" class="small">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div>
        <h2>Asset Value History Analysis</h2>
        <p class="text-muted">View real asset value trends and historical data from database</p>
      </div>
      <div class="row">
        <button onclick="refreshData()" class="small">Refresh Data</button>
        <button onclick="exportData()" class="small">Export Data</button>
      </div>
    </div>

    <!-- Asset Selection -->
    <div class="card">
      <div class="row" style="margin-bottom: 20px;">
        <div class="col">
          <label>Select Asset</label>
          <select id="assetSelect" onchange="updateAssetHistory()">
            <option value="">Please select an asset to view</option>
          </select>
        </div>
        <div class="col">
          <label>Time Range</label>
          <select id="timeRange" onchange="updateTimeRange()">
            <option value="7d">Last 7 days</option>
            <option value="30d" selected>Last 30 days</option>
            <option value="90d">Last 90 days</option>
            <option value="1y">Last year</option>
            <option value="all">All time</option>
          </select>
        </div>
        <div class="col">
          <label>Chart Type</label>
          <select id="chartType" onchange="updateChartType()">
            <option value="line" selected>Line Chart</option>
            <option value="bar">Bar Chart</option>
            <option value="area">Area Chart</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Current Value Summary -->
    <div class="grid" id="valueSummary" style="display: none;">
      <div class="card">
        <h3>Current Value</h3>
        <div style="font-size: 24px; font-weight: bold; color: var(--accent);" id="currentValue">$0</div>
        <p class="text-muted">Per unit price</p>
      </div>
      
      <div class="card">
        <h3>Last Change</h3>
        <div style="font-size: 24px; font-weight: bold;" id="dailyChange">+0%</div>
        <p class="text-muted">From previous record</p>
      </div>
      
      <div class="card">
        <h3>Total Change</h3>
        <div style="font-size: 24px; font-weight: bold;" id="weeklyChange">+0%</div>
        <p class="text-muted">From first record</p>
      </div>
      
      <div class="card">
        <h3>Records</h3>
        <div style="font-size: 24px; font-weight: bold;" id="monthlyChange">0</div>
        <p class="text-muted">Total history records</p>
      </div>
    </div>

    <!-- Chart Container -->
    <div class="card">
      <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Value Trend Chart</h3>
        <div class="row">
          <button onclick="toggleFullscreen()" class="small">Fullscreen</button>
          <button onclick="downloadChart()" class="small">Download Chart</button>
        </div>
      </div>
      <div style="position: relative; height: 400px;">
        <canvas id="valueChart"></canvas>
      </div>
    </div>

    <!-- Historical Data Table -->
    <div class="card">
      <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Historical Data</h3>
        <div class="row">
          <select id="tableFilter" onchange="filterTable()">
            <option value="all">All Data</option>
            <option value="7d">Last 7 days</option>
            <option value="30d">Last 30 days</option>
            <option value="90d">Last 90 days</option>
          </select>
        </div>
      </div>
      <div id="historyTable">
        <div class="text-muted text-center" style="padding: 40px;">
          <div class="spinner"></div>
          <p>Loading historical data...</p>
        </div>
      </div>
    </div>

    <!-- Performance Metrics -->
    <div class="card">
      <h3>Performance Metrics</h3>
      <div class="grid">
        <div class="card">
          <h4>Highest Value</h4>
          <div style="font-size: 20px; font-weight: bold; color: var(--success);" id="highestPrice">$0</div>
          <p class="text-muted" id="highestPriceDate">-</p>
        </div>
        
        <div class="card">
          <h4>Lowest Value</h4>
          <div style="font-size: 20px; font-weight: bold; color: var(--error);" id="lowestPrice">$0</div>
          <p class="text-muted" id="lowestPriceDate">-</p>
        </div>
        
        <div class="card">
          <h4>Average Value</h4>
          <div style="font-size: 20px; font-weight: bold;" id="averagePrice">$0</div>
          <p class="text-muted">Mean value</p>
        </div>
        
        <div class="card">
          <h4>Volatility</h4>
          <div style="font-size: 20px; font-weight: bold;" id="volatility">0%</div>
          <p class="text-muted">Price volatility</p>
        </div>
      </div>
    </div>

    <!-- Market Comparison -->
    <div class="card">
      <h3>Market Analysis</h3>
      <div class="grid">
        <div class="card">
          <h4>Relative Performance</h4>
          <div style="font-size: 18px; font-weight: bold;" id="relativePerformance">+0%</div>
          <p class="text-muted">vs market average</p>
        </div>
        
        <div class="card">
          <h4>Risk Rating</h4>
          <div id="riskRating" class="badge info">Medium</div>
          <p class="text-muted">Risk assessment</p>
        </div>
        
        <div class="card">
          <h4>Recommendation</h4>
          <div id="recommendation" class="badge success">Hold</div>
          <p class="text-muted">Investment advice</p>
        </div>
        
        <div class="card">
          <h4>Data Points</h4>
          <div style="font-size: 18px; font-weight: bold;" id="tradingVolume">0</div>
          <p class="text-muted">Total records</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = 'http://localhost:5001'; // Backend API server
    const user = JSON.parse(sessionStorage.getItem('user') || '{}');
    let assets = [];
    let selectedAsset = null;
    let valueHistory = [];
    let chart = null;
    
    // Check if user is manager
    if (user.is_manager) {
      document.getElementById('adminLink').style.display = 'inline-block';
    }

    async function fetchAssets() {
      try {
        console.log('Fetching assets from API...');
        const response = await fetch(`${API}/assets`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Assets response:', data);
        
        // Extract assets array from the response
        assets = data.assets || [];
        
        const select = document.getElementById('assetSelect');
        select.innerHTML = '<option value="">Please select an asset to view</option>';
        
        assets.forEach(asset => {
          const option = document.createElement('option');
          option.value = asset.asset_id;
          option.textContent = `${asset.asset_name} - $${(parseFloat(asset.total_value) / parseInt(asset.total_unit)).toFixed(2)}/unit`;
          select.appendChild(option);
        });
        
        console.log(`Loaded ${assets.length} assets`);
      } catch (error) {
        console.error('Error fetching assets:', error);
        showError('Failed to load asset data. Please try again later.');
      }
    }

    async function fetchValueHistory(assetId, timeRange) {
      try {
        console.log(`Fetching value history for asset ${assetId} with time range ${timeRange}...`);
        
        // Calculate date range based on timeRange selection
        const toDate = new Date();
        let fromDate = new Date();
        
        switch (timeRange) {
          case '7d':
            fromDate.setDate(toDate.getDate() - 7);
            break;
          case '30d':
            fromDate.setDate(toDate.getDate() - 30);
            break;
          case '90d':
            fromDate.setDate(toDate.getDate() - 90);
            break;
          case '1y':
            fromDate.setFullYear(toDate.getFullYear() - 1);
            break;
          case 'all':
            fromDate = null; // No from date means get all history
            break;
          default:
            fromDate.setDate(toDate.getDate() - 30);
        }
        
        // Build API URL with query parameters
        let apiUrl = `${API}/assets/${assetId}/values`;
        const params = new URLSearchParams();
        if (fromDate) {
          // Use ISO 8601 format (backend handles both formats)
          params.append('from', fromDate.toISOString());
        }
        // Use ISO 8601 format for 'to' as well
        params.append('to', toDate.toISOString());
        
        if (params.toString()) {
          apiUrl += '?' + params.toString();
        }
        
        console.log('Fetching value history from:', apiUrl);
        
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Value history response:', data);
        
        if (data.status === 'success' && data.items) {
          // Convert API response to the format expected by the UI
          valueHistory = data.items.map(item => ({
            date: item.recorded_at.split('T')[0],
            value: parseFloat(item.value),
            volume: 0, // No volume data in our system
            source: item.source,
            reason: item.reason,
            adjusted_by: item.adjusted_by
          }));
          
          console.log(`Loaded ${valueHistory.length} value history records`);
          
          updateValueSummary();
          updateChart();
          updateHistoryTable();
          updatePerformanceMetrics();
          updateMarketComparison();
        } else {
          throw new Error('Invalid response format from API');
        }
      } catch (error) {
        console.error('Error fetching value history:', error);
        showError('Failed to load historical data. Please try again later: ' + error.message);
        
        // Show empty state instead of mock data
        valueHistory = [];
        document.getElementById('valueSummary').style.display = 'none';
        document.getElementById('historyTable').innerHTML = '<p class="text-muted text-center">No historical data available</p>';
        if (chart) {
          chart.destroy();
          chart = null;
        }
      }
    }

    function updateValueSummary() {
      if (valueHistory.length === 0) return;
      
      const current = valueHistory[valueHistory.length - 1];
      const previous = valueHistory[valueHistory.length - 2] || current;
      const first = valueHistory[0];
      
      document.getElementById('currentValue').textContent = `$${current.value.toFixed(2)}`;
      
      // Calculate change from previous record (not necessarily daily)
      const changeFromPrevious = ((current.value - previous.value) / previous.value * 100).toFixed(2);
      const changeFromFirst = ((current.value - first.value) / first.value * 100).toFixed(2);
      
      // Show change from previous record
      document.getElementById('dailyChange').textContent = `${changeFromPrevious > 0 ? '+' : ''}${changeFromPrevious}%`;
      document.getElementById('dailyChange').className = changeFromPrevious > 0 ? 'text-success' : 'text-error';
      
      // Show change from first record (total change)
      document.getElementById('weeklyChange').textContent = `${changeFromFirst > 0 ? '+' : ''}${changeFromFirst}%`;
      document.getElementById('weeklyChange').className = changeFromFirst > 0 ? 'text-success' : 'text-error';
      
      // Show total records count
      document.getElementById('monthlyChange').textContent = `${valueHistory.length} records`;
      document.getElementById('monthlyChange').className = 'text-info';
      
      document.getElementById('valueSummary').style.display = 'block';
    }

    function updateChart() {
      const ctx = document.getElementById('valueChart').getContext('2d');
      const chartType = document.getElementById('chartType').value;
      
      if (chart) {
        chart.destroy();
      }
      
      const isBar = chartType === 'bar';
      const data = {
        labels: valueHistory.map(h => new Date(h.date).toLocaleDateString()),
        datasets: [{
          label: 'Unit Price ($)',
          data: valueHistory.map(h => h.value),
          borderColor: '#f7c948',
          // For bar chart use solid yellow so bars are visible; for area use translucent fill; for line keep transparent background
          backgroundColor: isBar ? '#f7c948' : (chartType === 'area' ? 'rgba(247, 201, 72, 0.1)' : 'transparent'),
          fill: chartType === 'area',
          tension: 0.4,
          borderWidth: isBar ? 0 : 2
        }]
      };
      
      const options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#eee'
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#a0a0a0'
            },
            grid: {
              color: '#2a2a2a'
            }
          },
          y: {
            ticks: {
              color: '#a0a0a0',
              callback: function(value) {
                return '$' + value.toFixed(2);
              }
            },
            grid: {
              color: '#2a2a2a'
            }
          }
        }
      };
      
      chart = new Chart(ctx, {
        type: chartType === 'area' ? 'line' : chartType,
        data: data,
        options: options
      });
    }

    function updateHistoryTable() {
      const container = document.getElementById('historyTable');
      
      if (valueHistory.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No historical data available</p>';
        return;
      }
      
      const filteredHistory = filterHistoryByRange(valueHistory);
      
      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Value</th>
              <th>Change</th>
              <th>Change %</th>
              <th>Source</th>
              <th>Reason</th>
              <th>Adjusted By</th>
            </tr>
          </thead>
          <tbody>
            ${filteredHistory.map((h, index) => {
              const prevValue = index > 0 ? filteredHistory[index - 1].value : h.value;
              const change = h.value - prevValue;
              const changePercent = ((change / prevValue) * 100).toFixed(2);
              
              const sourceBadge = h.source === 'manual_adjust' ? 
                '<span class="badge warning">Manual</span>' : 
                '<span class="badge info">System</span>';
              
              const reason = h.reason || '-';
              
              return `
                <tr>
                  <td>${new Date(h.date).toLocaleDateString()}</td>
                  <td>$${h.value.toFixed(2)}</td>
                  <td class="${change > 0 ? 'text-success' : 'text-error'}">${change > 0 ? '+' : ''}$${change.toFixed(2)}</td>
                  <td class="${change > 0 ? 'text-success' : 'text-error'}">${change > 0 ? '+' : ''}${changePercent}%</td>
                  <td>${sourceBadge}</td>
                  <td>${reason}</td>
                  <td>${h.adjusted_by ? `User ${h.adjusted_by}` : '-'}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    function filterHistoryByRange(history) {
      const filter = document.getElementById('tableFilter').value;
      const days = getDaysForRange(filter);
      return history.slice(-days);
    }

    function getDaysForRange(timeRange) {
      switch (timeRange) {
        case '7d': return 7;
        case '30d': return 30;
        case '90d': return 90;
        case 'all': return 365;
        default: return 30;
      }
    }

    function updatePerformanceMetrics() {
      if (valueHistory.length === 0) return;
      
      const values = valueHistory.map(h => h.value);
      const highest = Math.max(...values);
      const lowest = Math.min(...values);
      const average = values.reduce((sum, val) => sum + val, 0) / values.length;
      
      // Calculate volatility (standard deviation)
      const variance = values.reduce((sum, val) => sum + Math.pow(val - average, 2), 0) / values.length;
      const volatility = Math.sqrt(variance) / average * 100;
      
      const highestIndex = values.indexOf(highest);
      const lowestIndex = values.indexOf(lowest);
      
      document.getElementById('highestPrice').textContent = `$${highest.toFixed(2)}`;
      document.getElementById('highestPriceDate').textContent = new Date(valueHistory[highestIndex].date).toLocaleDateString();
      
      document.getElementById('lowestPrice').textContent = `$${lowest.toFixed(2)}`;
      document.getElementById('lowestPriceDate').textContent = new Date(valueHistory[lowestIndex].date).toLocaleDateString();
      
      document.getElementById('averagePrice').textContent = `$${average.toFixed(2)}`;
      document.getElementById('volatility').textContent = `${volatility.toFixed(2)}%`;
    }

    function updateMarketComparison() {
      if (valueHistory.length === 0) return;
      
      // Calculate performance based on real data
      const firstValue = valueHistory[0].value;
      const lastValue = valueHistory[valueHistory.length - 1].value;
      const performance = ((lastValue - firstValue) / firstValue * 100).toFixed(1);
      
      // Calculate risk based on volatility
      const marketValues = valueHistory.map(h => h.value);
      const marketAverage = marketValues.reduce((sum, val) => sum + val, 0) / marketValues.length;
      const marketVariance = marketValues.reduce((sum, val) => sum + Math.pow(val - marketAverage, 2), 0) / marketValues.length;
      const marketVolatility = Math.sqrt(marketVariance) / marketAverage * 100;
      
      // Determine risk rating based on volatility
      let riskRating, riskClass;
      if (marketVolatility < 5) {
        riskRating = 'Low';
        riskClass = 'success';
      } else if (marketVolatility < 15) {
        riskRating = 'Medium';
        riskClass = 'warning';
      } else {
        riskRating = 'High';
        riskClass = 'error';
      }
      
      // Determine recommendation based on performance
      let recommendation, recClass;
      if (performance > 10) {
        recommendation = 'Buy';
        recClass = 'success';
      } else if (performance > -5) {
        recommendation = 'Hold';
        recClass = 'warning';
      } else {
        recommendation = 'Sell';
        recClass = 'error';
      }
      
      document.getElementById('relativePerformance').textContent = `${performance > 0 ? '+' : ''}${performance}%`;
      document.getElementById('relativePerformance').className = performance > 0 ? 'text-success' : 'text-error';
      
      document.getElementById('riskRating').textContent = riskRating;
      document.getElementById('riskRating').className = `badge ${riskClass}`;
      
      document.getElementById('recommendation').textContent = recommendation;
      document.getElementById('recommendation').className = `badge ${recClass}`;
      
      document.getElementById('tradingVolume').textContent = valueHistory.length;
    }

    function updateAssetHistory() {
      const assetId = document.getElementById('assetSelect').value;
      const timeRange = document.getElementById('timeRange').value;
      
      if (!assetId) {
        document.getElementById('valueSummary').style.display = 'none';
        document.getElementById('historyTable').innerHTML = '<p class="text-muted text-center">Please select an asset</p>';
        if (chart) {
          chart.destroy();
          chart = null;
        }
        return;
      }
      
      selectedAsset = assets.find(a => a.asset_id == assetId);
      fetchValueHistory(assetId, timeRange);
    }

    function updateTimeRange() {
      if (selectedAsset) {
        updateAssetHistory();
      }
    }

    function updateChartType() {
      if (chart) {
        updateChart();
      }
    }

    function filterTable() {
      updateHistoryTable();
    }

    function refreshData() {
      if (selectedAsset) {
        updateAssetHistory();
      } else {
        fetchAssets();
      }
    }

    function exportData() {
      if (valueHistory.length === 0) {
        showMessage('No data to export', false);
        return;
      }
      
      const csv = [
        ['Date', 'Value', 'Source', 'Reason', 'Adjusted By'],
        ...valueHistory.map(h => [
          h.date,
          h.value,
          h.source,
          h.reason || '',
          h.adjusted_by || ''
        ])
      ].map(row => row.join(',')).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `asset_${selectedAsset.asset_id}_value_history.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function toggleFullscreen() {
      const chartContainer = document.querySelector('#valueChart').parentElement;
      if (chartContainer.requestFullscreen) {
        chartContainer.requestFullscreen();
      }
    }

    function downloadChart() {
      if (chart) {
        const url = chart.toBase64Image();
        const a = document.createElement('a');
        a.href = url;
        a.download = `asset_${selectedAsset.asset_id}_chart.png`;
        a.click();
      }
    }

    function showError(message) {
      showMessage(message, false);
    }

    function showMessage(message, isSuccess) {
      const msg = document.createElement('div');
      msg.className = `msg ${isSuccess ? 'ok' : 'err'}`;
      msg.textContent = message;
      msg.style.position = 'fixed';
      msg.style.top = '20px';
      msg.style.right = '20px';
      msg.style.zIndex = '1001';
      document.body.appendChild(msg);
      
      setTimeout(() => {
        document.body.removeChild(msg);
      }, 3000);
    }

    function logout() {
      sessionStorage.clear();
      location.href = 'login.html';
    }

    // Load data on page load
    fetchAssets();
  </script>
</body>
</html>